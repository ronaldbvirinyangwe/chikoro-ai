import express from 'express'; 
import { Paynow } from 'paynow'; 
import cors from 'cors';

const app = express(); 

// CORS configuration 
const corsOptions = { 
  origin: ['https://chikoro-ai.com', 'http://13.246.95.40:5173'],
  methods: ['GET', 'POST'], // Allowed methods 
  allowedHeaders: ['Authorization', 'Content-Type'], // Allowed headers 
}; 

app.use(cors()); 
app.use(express.json());

// Handle preflight requests 
app.options('*', cors(corsOptions));

const paynow = new Paynow("19208", "1569d49f-67e7-4e3b-9b7c-168c7d37e312"); 
paynow.resultUrl = "http://example.com/gateways/paynow/update"; 
paynow.returnUrl = "https://www.chikoro-ai.com"; // Ensure this is a full URL

const authenticateUser  = (token) => { 
  // Verify token and authenticate user 
  return { id: 1, email: 'user@example.com' }; // Dummy user for demonstration 
};

app.post('/bhadhara', async (req, res) => {
  try { 
    const token = req.headers.authorization; 
    if (!token) {
      return res.status(401).json({ success: false, error: 'Unauthorized' }); 
    }
    
    const user = authenticateUser (token);
    if (!user) {
      return res.status(401).json({ success: false, error: 'Invalid token' });
    }

    const { phoneNumber } = req.body;

    // Create payment with a unique reference
    const payment = paynow.createPayment(`Order-${Date.now()}`, "ronaldbvirinyangwe@icloud.com");

    // Add items (amount in USD)
    payment.add("Chikoro AI Subscription", 0.01);
    console.log('Payment created:', payment);  

    // Send mobile money payment
    const response = await paynow.sendMobile(payment, phoneNumber, 'ecocash'); // or 'onemoney' or 'telecash'

    if (response.success) { 
      const { pollUrl, instructions } = response;
      
      // Return the response to client
      res.status(200).json({
        success: true,
        pollUrl,
        instructions
      });

      // Optional: Poll for status
      const checkStatus = async () => {
        try {
          const status = await paynow.pollTransaction(pollUrl);
          console.log("Transaction Status:", status);
          if (status.paid) {
            console.log("Payment completed successfully");
            // Here you can update the database or notify the user
          }
        } catch (error) {
          console.error("Polling Error:", error);
        }
      };

      // Check status after 15 seconds
      setTimeout(checkStatus, 15000);
      
    } else {
      throw new Error(response.error || "Payment initiation failed");
    }
  } catch (error) {
    console.error("Payment Error:", error); 
    res.status(500).json({
      success: false, 
      error: error.message 
    });
  } 
});

const checkPaymentStatusWithRetry = async (pollUrl, retries = 3, delay = 2000) => {
  for (let i = 0; i < retries; i++) {
    try {
      const status = await paynow.pollTransaction(pollUrl);
      return status; // Return the successful status
    } catch (error) {
      console.error(`Attempt ${i + 1} - Error checking payment status:`, error);
      if (i < retries - 1) {
        await new Promise(res => setTimeout(res, delay)); // Wait before retrying
      } else {
        throw error; // Rethrow the error after all retries
      }
    }
  }
};

app.post('/check-payment-status', async (req, res) => {
  const { pollUrl } = req.body;

  // Validate input
  if (!pollUrl) {
    return res.status(400).json({ success: false, error: 'pollUrl is required.' });
  }

  try {
    const status = await checkPaymentStatusWithRetry(pollUrl);
    console.log('Payment Status:', status); // Log the full status response

    // Check if the payment status is 'paid'
    if (status.status === 'paid') {
       console.log('Payment completed, redirecting to:', response.data.returnUrl););
      navigate(response.data.returnUrl); // Redirect to return URL on successful payment);
    }

    // If not paid, respond with the status
    return res.status(200).json({ success: false, status });
  } catch (error) {
    console.error("Error checking payment status:", error);
    return res.status(500).json({ success: false, error: error.message });
  }
});

app.listen(3080, () => {
  console.log('Server listening on port 3080');
});

